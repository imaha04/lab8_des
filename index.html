<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rock Paper Scissors</title>
</head>
<body>
  <h1>Rock Paper Scissors</h1>
  <p>Select your move:</p>
  <button onclick="makeMove(1)">Rock</button>
  <button onclick="makeMove(2)">Scissors</button>
  <button onclick="makeMove(3)">Paper</button>
  <div id="result"></div>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.5.3/dist/web3.min.js"></script>
<script> 
        // Проверка доступности Web3 и активации MetaMask 
        window.addEventListener('load', async () => { 
            if (window.ethereum) { 
                window.web3 = new Web3(window.ethereum); 
                try { 
                    // Запрос разрешения на доступ к аккаунту MetaMask 
                    await ethereum.request({ method: 'eth_requestAccounts' }); 
                    console.log('MetaMask is enabled.'); 
                } catch (error) { 
                    console.error('User denied account access to MetaMask:', error); 
                } 
            } else { 
                console.error('MetaMask is not installed!'); 
            } 
        }); 
 
        // Функция для вызова функции play вашего контракта 
        async function playGame(move) { 
            const accounts = await window.web3.eth.getAccounts(); 
            const contractAddress = '0x39d82C3E5B6918b17327C08d64D45BaF1edF6BbB'; 
            const abi =[
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "result",
				"type": "string"
			}
		],
		"name": "GameResult",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "enum RockPaperScissors.Choice",
				"name": "_playerChoice",
				"type": "uint8"
			}
		],
		"name": "play",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
]; 
            const contract = new window.web3.eth.Contract(abi, contractAddress); 
 
            try { 
                // Отправка транзакции из аккаунта MetaMask 
                const result = await contract.methods.play(move).send({ from: accounts[0] }); 
                console.log('Game played successfully:', result); 
 
                // Ожидание завершения транзакции 
                const receipt = await window.web3.eth.getTransactionReceipt(result.transactionHash); 
 
                // Получение результата игры из события GamePlayed 
                const eventABI = abi.find(abi => abi.name === 'GamePlayed'); 
                const eventTopic = window.web3.utils.sha3('GamePlayed(address,uint8,uint8,uint8)'); 
                const logs = receipt.logs.filter(log => log.topics.includes(eventTopic)); 
                const event = contract._decodeEventABI.call(eventABI, logs[0]); 
 
                // Обновление результата на странице HTML 
                updateResult(event.returnValues); 
            } catch (error) { 
                console.error('Error playing game:', error); 
            } 
        } 
 
        // Функция для обновления результата на странице HTML 
        function updateResult({ playerMove, machineMove, result }) { 
            const resultElement = document.getElementById('result'); 
 
            // Map numerical values to their corresponding strings 
            const moveMap = { 
                1: 'rock', 
                2: 'paper', 
                3: 'scissors' 
            }; 
 
            const resultMap = { 
                1: 'win', 
                2: 'lose', 
                3: 'draw' 
            }; 
 
            // Update result element with mapped values 
            resultElement.innerHTML = Player move: ${moveMap[playerMove]}, Machine move: ${moveMap[machineMove]}, Result: ${resultMap[result]}; 
         } 
    </script> 
 
</body> 
</html>
